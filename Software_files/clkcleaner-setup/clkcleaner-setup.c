/*
* clkcleaner-setup.c
*
* Author: Luke Bidulka
* Company: TRIUMF
* Date: Nov 25, 2020
*
* Purpose: Setup and initialize the 8t49n241 Clock Cleaner on the NuPRISM board over i2c
*
*/

/***************************** Include Files **********************************/
#include "cc-i2c.c"

/************************** Constant Definitions ******************************/

#define CLOCK_CLEANER_SLAVE_ADDR	0x7C
#define CLOCK_CLEANER_SCLK_RATE		100000
#define CLOCK_CLEANER_OUTEN_REG		0x0039
#define CLOCK_CLEANER_OUTEN_VAL		0x0F
#define CLOCK_CLEANER_STOP_VAL		0x00

#define CLOCK_CLEANER_BUSS_ADAPTER 0

/************************** Variable Definitions ******************************/

volatile uint8_t init_clock_cleaner_settings[] = {0x09,0x50,0x00,0x60,0x60,0x01,0x7c,0x01,0x03,0x00,0x00,0x00,0x01,0xe9,0x00,0x01,0xe9,0x00,0x5b,0xb0,
									0x00,0x5b,0xb0,0x7d,0x6d,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0x0b,0x3f,0x00,0x18,0x00,
									0x00,0x00,0x00,0x00,0x01,0x00,0x00,0xd0,0x0f,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x00,
									0x00,0x44,0x44,0x01,0x00,0x02,0x00,0x00,0x0c,0x00,0x00,0x0c,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0xe0,0x02,0x2b,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0x00,0x00,0x13,0x00,
									0x00,0x53,0x27,0xcc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x00,0x04,0x12,0x01,0x9d,0x51,0x01,
									0x9d,0x51,0x3f,0xff,0x00,0x21,0x0f,0x07,0x01,0x0b,0xde};

// FD of the IIC device opened
int i2c_fd = -1;

/******************************* Functions ************************************/

// Writes initial settings to the clock cleaner
int clock_cleaner_init(){
    uint8_t result;
    int write_flag = -1;

    //write all registers specified in init array
	for(uint16_t i = 0; i < sizeof(init_clock_cleaner_settings)/sizeof(init_clock_cleaner_settings[0]); i++){
		write_flag  = i2c_write(i2c_fd, CLOCK_CLEANER_SLAVE_ADDR, i, init_clock_cleaner_settings[i]);
		usleep(1000);
	}

    if(write_flag == 0){
		printf("Clock cleaner settings initialized\n");
	} else {
		printf("Failed to initialize clock cleaner\n");
	}
	return write_flag;
}

// Runs clock cleaner setup sequence
int clock_cleaner_start(){
    int i2c_init_flag = -1;
    int cc_init_flag = -1;
    int cc_start_flag = -1;

    printf("Starting clock cleaner...\n");

    // Initialize i2c device
    printf("Initializing i2c adapter...\n");
    i2c_init_flag = i2c_init(&i2c_fd, CLOCK_CLEANER_BUSS_ADAPTER);

    // If we initialized i2c successfully, initialize the clock cleaner settings
    if (i2c_init_flag == 0){
        printf("Initializing clock cleaner...\n");
        cc_init_flag = clock_cleaner_init(i2c_fd);
    }

    // If we initialized Clock Cleaner successfully (and thus i2c), enable/start its outputs
    if (cc_init_flag == 0){
        printf("Enabling clock cleaner output...\n");
        cc_start_flag = i2c_write(i2c_fd, CLOCK_CLEANER_SLAVE_ADDR, CLOCK_CLEANER_OUTEN_REG, CLOCK_CLEANER_OUTEN_VAL);
    }

    
    if (cc_start_flag == 0){
        printf("Clock cleaner started\n");
        return 0;
    }
    else {
        printf("Failed to start clock cleaner\n");
        return -1;
    }
}

// Runs clock cleaner stop sequence (INCOMPLETE)
int clock_cleaner_stop(void){
    return 0;
}

/********************************* Main ***************************************/

int main(int argc, char **argv){

    printf("\nClock Cleaner Setup Application\n\n");

    clock_cleaner_start();

    // Close i2c device
    i2c_close(i2c_fd);

    printf("\nClock Cleaner Setup Complete\n\n");
    return 0;
}